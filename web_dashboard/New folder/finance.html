<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Mitra AI ‚Äî Finance Dashboard (Voice)</title>

<style>
/* same finance visual theme + small header mic controls */
body{
  margin:0;
  background: url("https://images.unsplash.com/photo-1567427017947-545c5f8d16ad?auto=format&fit=crop&w=1600&q=80") no-repeat center center fixed;
  background-size: cover;
  font-family: "Poppins",sans-serif;
  color:#fff;
}
body::before{content:"";position:fixed;inset:0;background:rgba(0,0,0,0.55);backdrop-filter:blur(2px);z-index:-1}

.header{display:flex;align-items:center;gap:12px;padding:18px;max-width:1100px;margin:20px auto}
.h-title{flex:1;font-size:1.6rem;color:#00ffcc;font-weight:700}
.controls{display:flex;gap:8px;align-items:center}
.btn{padding:8px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
.btn-voice{background:#00ffcc;color:#021208}
.btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.08);color:#eafaff}
.muted{color:rgba(220,255,255,0.7);font-size:0.95rem}

.container{max-width:1100px;margin:10px auto;display:grid;grid-template-columns:1fr 420px;gap:22px;padding:0 18px}
.card{background:rgba(0,255,180,0.06);border:1px solid rgba(0,255,180,0.12);padding:18px;border-radius:12px;backdrop-filter:blur(6px)}
.input-row{display:flex;gap:8px;margin-top:12px}
.input-row input{flex:1;padding:10px;border-radius:8px;border:none;background:rgba(0,0,0,0.35);color:#fff}
.small{font-size:0.9rem;color:#dff}

.list{margin-top:12px;display:flex;flex-direction:column;gap:10px}
.item{background:rgba(0,0,0,0.35);padding:10px;border-radius:8px;border-left:4px solid #00ffcc;display:flex;justify-content:space-between;align-items:center}
.del{background:none;border:0;color:#ff7b7b;font-size:1.1rem;cursor:pointer}

.level{height:9px;border-radius:6px;background:#071217;border:1px solid #183040;overflow:hidden;width:160px}
.level>div{height:100%;width:6%;background:linear-gradient(90deg,#6dffd1,#86a6ff)}

.bottom-note{max-width:1100px;margin:18px auto;text-align:center;color:#bfeff0;font-size:0.95rem}
.back{display:block;text-align:center;color:#00ffcc;text-decoration:none;margin:18px auto}
</style>
</head>
<body>

<div class="header">
  <div class="h-title">Mitra AI ‚Äî Finance Dashboard</div>

  <div class="controls">
    <button id="startMic" class="btn btn-voice">Start</button>
    <button id="stopMic" class="btn btn-ghost">Stop</button>
    <label class="muted">Wake <input id="wake" type="checkbox" checked></label>
    <div class="level"><div id="meter"></div></div>
  </div>
</div>

<div class="container">
  <div class="card">
    <h3 style="margin:0;color:#00ffcc">Add Expense / Note</h3>
    <p class="small muted">You can type or say: <b>"add expense 250 dinner"</b> or <b>"add note paid phone bill"</b></p>

    <div class="input-row">
      <input id="finText" placeholder="e.g. 250 dinner ‚Äî or 'rent 12000' or 'note paid'"/>
      <button id="finAdd" class="btn btn-voice">Add</button>
    </div>

    <div class="list" id="finList" aria-live="polite"></div>
  </div>

  <aside class="card">
    <h3 style="margin:0;color:#00ffcc">Summary</h3>
    <p class="small muted">Simple, static summary calculated from stored entries</p>

    <div style="margin-top:12px">
      <div>Total entries: <strong id="finCount">0</strong></div>
      <div style="margin-top:8px">Total numeric amount (detected): <strong id="finTotal">‚Çπ0</strong></div>
      <div style="margin-top:8px">Daily average (simple): <strong id="finAvg">‚Çπ0</strong></div>
    </div>
  </aside>
</div>

<div class="bottom-note">Tip: Use wake word (checked) ‚Äî speak phrases like <i>‚Äúadd expense 200 pizza‚Äù</i> or <i>‚Äúadd note electricity paid‚Äù</i></div>

<a class="back" href="index.html">‚Üê Back to Dashboard</a>

<script>
/* localStorage model */
let items = JSON.parse(localStorage.getItem("mitraFinance")||"[]");
function save(){ localStorage.setItem("mitraFinance", JSON.stringify(items)); updateSummary(); render(); }
function render(){
  const el = document.getElementById("finList"); el.innerHTML="";
  if(!items.length){ el.innerHTML = '<div class="muted">No entries yet</div>'; return; }
  items.slice().reverse().forEach((it,i)=>{
    const idx = items.length-1-i;
    const div = document.createElement("div"); div.className="item";
    div.innerHTML = `<div><strong>${it.text}</strong><div class="muted">${it.when}</div></div>
      <div><button class="del" data-i="${idx}">üóë</button></div>`;
    el.appendChild(div);
  });
  el.querySelectorAll(".del").forEach(b=>b.onclick=()=>{ items.splice(+b.dataset.i,1); save(); });
}
function updateSummary(){
  document.getElementById("finCount").textContent = items.length;
  // detect numbers in text and sum
  let total=0; let days = {};
  items.forEach(it=>{
    const m = it.text.match(/(-?\d+(?:\.\d+)?)/);
    if(m) total += Number(m[0]);
    const d = it.when.split("T")[0];
    days[d] = (days[d]||0) + (m?Number(m[0]):0);
  });
  document.getElementById("finTotal").textContent = "‚Çπ" + Math.round(total);
  const dayKeys = Object.keys(days);
  const avg = dayKeys.length ? Math.round(total / dayKeys.length) : 0;
  document.getElementById("finAvg").textContent = "‚Çπ" + avg;
}

/* add button */
document.getElementById("finAdd").onclick = ()=>{
  const txt = document.getElementById("finText").value.trim(); if(!txt) return;
  items.push({ text: txt, when: new Date().toISOString() }); document.getElementById("finText").value=""; save();
};

/* voice (Web Speech) */
const meter = document.getElementById("meter");
let rec=null, analyser=null, raf=null, micStream=null; let manualStop=false;
async function warmMic(){
  if(micStream) return;
  try{
    micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    const ctx = new (window.AudioContext||window.webkitAudioContext)();
    const src = ctx.createMediaStreamSource(micStream);
    analyser = ctx.createAnalyser(); analyser.fftSize=1024; src.connect(analyser);
    (function loop(){ if(!analyser) return; const arr = new Uint8Array(analyser.fftSize); analyser.getByteTimeDomainData(arr); let peak=0; for(let v of arr){ const p = Math.abs(v-128); if(p>peak) peak=p; } meter.style.width = Math.min(100, Math.max(6,(peak/64)*100)) + '%'; raf = requestAnimationFrame(loop); })();
  }catch(e){ console.warn("mic denied",e); throw e; }
}
function SRClass(){ return window.SpeechRecognition || window.webkitSpeechRecognition; }

function startListening(){
  const Klass = SRClass(); if(!Klass){ alert("SpeechRecognition not supported in this browser"); return; }
  manualStop=false;
  if(rec){ try{ rec.onend=null; rec.stop(); }catch{} }
  rec = new Klass(); rec.lang = "en-IN"; rec.interimResults = false; rec.continuous=false;
  rec.onstart = ()=>{ document.getElementById("startMic").textContent="Listening‚Ä¶"; };
  rec.onend = ()=>{ if(!manualStop){ setTimeout(()=>{ try{ rec.start(); }catch{} },150); } else { document.getElementById("startMic").textContent="Start"; } };
  rec.onresult = (ev)=>{ for(let i=ev.resultIndex;i<ev.results.length;i++){ if(ev.results[i].isFinal){ const t = ev.results[i][0].transcript.trim(); handleVoice(t); } } };
  rec.onerror = (e)=>{ console.warn("SR error",e); };
  try{ rec.start(); }catch(e){ console.warn("start fail", e); }
}

function stopListening(){ manualStop=true; try{ rec && rec.stop(); }catch{} document.getElementById("startMic").textContent="Start"; }

document.getElementById("startMic").onclick = async ()=>{ try{ await warmMic(); }catch(e){ alert("Allow microphone"); return; } startListening(); };
document.getElementById("stopMic").onclick = ()=> stopListening();

/* parse voice: finance commands:
   - add expense 250 dinner
   - add note paid electricity
   - expense 450 lunch
*/
function handleVoice(txt){
  const t = txt.toLowerCase();
  addLog("Heard: "+txt);
  const wakeOn = document.getElementById("wake").checked;
  let processed = t;
  if(wakeOn){
    if(processed.startsWith("hey mitra")) processed = processed.replace(/^hey mitra[, ]*/,"");
    else if(processed.startsWith("mitra")) processed = processed.replace(/^mitra[, ]*/,"");
    else { addLog("Ignored (no wake)"); return; }
  }
  // commands
  let m;
  m = processed.match(/^(?:add )?(?:expense|spent|expense of|pay|paid) ?\s*([0-9]+(?:\.[0-9]+)?)\s*(.*)$/);
  if(m){ const amount = m[1]; const note = m[2]||"expense"; const text = `${amount} ${note}`; items.push({text, when: new Date().toISOString()}); save(); addLog("Added expense: "+text); return; }
  m = processed.match(/^(?:add )?(?:note|memo|remind) (.+)$/);
  if(m){ const text = m[1]; items.push({text, when: new Date().toISOString()}); save(); addLog("Saved note: "+text); return; }
  m = processed.match(/^(?:add )?([0-9]+(?:\.[0-9]+)?)\s*(.*)$/);
  if(m){ const text = m[1] + " " + (m[2]||""); items.push({text, when: new Date().toISOString()}); save(); addLog("Added numeric note: "+text); return; }
  addLog("No match: "+txt);
}

/* small log panel */
function addLog(s){ const L = document.createElement("div"); L.textContent = s; const box = document.createElement("div"); box.appendChild(L); const out = document.createElement("div"); out.className="muted"; out.appendChild(box); console.log(s); }

/* init */
render(); updateSummary();
</script>
</body>
</html>
