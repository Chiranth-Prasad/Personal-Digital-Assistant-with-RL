<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" /><meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Mitra AI ‚Äî Healthcare (AI-Powered)</title>
<script src="api.js"></script>
<style>
body{
  margin:0;
  background:url("https://images.unsplash.com/photo-1526256262350-7da7584cf5eb?auto=format&fit=crop&w=1600&q=80") no-repeat center center fixed;
  background-size:cover;
  font-family:Poppins,sans-serif;
  color:#fff
}
body::before{content:"";position:fixed;inset:0;background:rgba(0,0,0,0.6);backdrop-filter:blur(3px);z-index:-1}
.header{max-width:1100px;margin:22px auto;padding:18px;display:flex;align-items:center;gap:12px;
  background:rgba(0,0,0,0.3);backdrop-filter:blur(10px);border-radius:16px;border:1px solid rgba(255,171,171,0.2)}
.h-title{flex:1;font-size:1.6rem;color:#ffabab;font-weight:700}
.controls{display:flex;gap:8px;align-items:center}
.btn{padding:8px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:700;transition:transform 0.2s}
.btn:hover{transform:translateY(-2px)}
.btn-voice{background:#ffabab;color:#041207}
.btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.08);color:#fff}
.container{max-width:1100px;margin:14px auto;padding:0 18px;display:grid;grid-template-columns:2fr 380px;gap:18px}
.card{background:rgba(255,150,150,0.06);padding:18px;border-radius:12px;border:1px solid rgba(255,150,150,0.12);backdrop-filter:blur(6px)}

.ai-section{
  background:rgba(255,171,171,0.15);
  padding:20px;
  border-radius:12px;
  border:1px solid rgba(255,171,171,0.3);
  margin-bottom:20px;
}
.ai-response{
  background:rgba(0,0,0,0.5);
  padding:12px;
  border-radius:8px;
  color:#ffabab;
  font-family:'Courier New',monospace;
  font-size:14px;
  min-height:60px;
  margin-top:10px;
}

.input-row{display:flex;gap:8px;margin-top:12px}
.input-row input{flex:1;padding:10px;border-radius:8px;border:none;background:rgba(0,0,0,0.35);color:#fff;outline:none}
.list{margin-top:12px;display:flex;flex-direction:column;gap:10px}
.med-item{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:10px;background:rgba(0,0,0,0.35);border-left:6px solid #ffabab}
.checkbox{width:20px;height:20px;border-radius:6px;border:1px solid rgba(255,255,255,0.12);display:inline-flex;align-items:center;justify-content:center;cursor:pointer;background:rgba(0,0,0,0.3)}
.checkbox.checked{background:#ffabab;color:#000}
.small{font-size:0.95rem;color:#ffe7e7}
.back{display:block;text-align:center;color:#ffabab;text-decoration:none;margin:18px auto}
@media(max-width:1000px){.container{grid-template-columns:1fr}}
</style>
</head>
<body>

<div class="header">
  <div class="h-title">üíä Mitra AI ‚Äî Healthcare</div>
  <div class="controls">
    <span class="small">Status: <span id="statusText">Idle</span></span>
    <button id="startMic" class="btn btn-voice">üéôÔ∏è Voice</button>
    <button id="stopMic" class="btn btn-ghost">Stop</button>
    <a href="index.html"><button class="btn btn-ghost">‚Üê Home</button></a>
  </div>
</div>

<div class="container">
  <main class="card">
    <h3 style="margin:0 0 15px 0;color:#ffabab">ü§ñ AI Medication Commands</h3>
    
    <div class="ai-section">
      <div class="input-row">
        <input id="aiInput" placeholder='Say: "Add medication paracetamol morning 500mg"'>
        <button id="aiSend" class="btn btn-voice">Send</button>
      </div>
      <div class="small" style="margin-top:8px">
        Natural language: "Take vitamin D in the morning", "Add aspirin 100mg evening"
      </div>
      <div id="aiResponse" class="ai-response">
        Try: "Add medication paracetamol morning 500mg"
      </div>
    </div>

    <h3 style="margin:20px 0 10px 0;color:#ffabab">üíä Medication Schedule</h3>
    <div class="list" id="medList">
      <div class="small">Loading...</div>
    </div>
  </main>

  <aside class="card">
    <h3 style="margin:0 0 15px 0;color:#ffabab">Today's Medications</h3>
    <div id="todayList" style="margin-top:12px">
      <div class="small">No medications for today</div>
    </div>
    
    <div style="margin-top:20px;padding-top:20px;border-top:1px solid rgba(255,171,171,0.2)">
      <h3 style="margin:0 0 10px 0;color:#ffabab">Quick Actions</h3>
      <button class="btn btn-voice" onclick="loadMeds()" style="width:100%">
        üîÑ Refresh
      </button>
    </div>
  </aside>
</div>

<a class="back" href="index.html">‚Üê Back to Dashboard</a>

<script>
const $ = s => document.querySelector(s);
let meds = [];
let recognition = null;
let isListening = false;

// Load medications
async function loadMeds() {
  try {
    const stored = localStorage.getItem('mitraMeds');
    meds = stored ? JSON.parse(stored) : [];
    renderMeds();
    renderToday();
  } catch (error) {
    console.error('Error loading meds:', error);
  }
}

// Render medications
function renderMeds() {
  const el = $('#medList');
  
  if (!meds || meds.length === 0) {
    el.innerHTML = '<div class="small">No medications scheduled. Use AI to add your first medication!</div>';
    return;
  }
  
  el.innerHTML = '';
  
  meds.slice().reverse().forEach((med, i) => {
    const idx = meds.length - 1 - i;
    const date = new Date(med.when || med.timestamp || Date.now());
    const div = document.createElement('div');
    div.className = 'med-item';
    div.innerHTML = `
      <div>
        <strong>üíä ${med.name || med.medicine}</strong>
        <div class="small">${med.time || 'Morning'} ‚Ä¢ ${med.dose || '‚Äî'} ‚Ä¢ ${date.toLocaleDateString()}</div>
      </div>
      <button class="del" onclick="deleteMed(${idx})">üóë</button>
    `;
    el.appendChild(div);
  });
}

// Render today's medications
function renderToday() {
  const el = $('#todayList');
  const today = new Date().toISOString().slice(0, 10);
  
  const todayMeds = meds.filter(m => {
    const medDate = new Date(m.when || m.timestamp || Date.now()).toISOString().slice(0, 10);
    return medDate === today || (m.repeat || 'daily') === 'daily';
  });
  
  if (!todayMeds || todayMeds.length === 0) {
    el.innerHTML = '<div class="small">No medications for today</div>';
    return;
  }
  
  el.innerHTML = '';
  
  todayMeds.forEach((med, i) => {
    const taken = !!med.takenToday;
    const div = document.createElement('div');
    div.className = 'med-item';
    div.innerHTML = `
      <div>
        <strong>${med.name || med.medicine}</strong>
        <div class="small">${med.time || 'Morning'} ‚Ä¢ ${med.dose || '‚Äî'}</div>
      </div>
      <div class="checkbox ${taken ? 'checked' : ''}" onclick="toggleTaken(${i})">
        ${taken ? '‚úì' : ''}
      </div>
    `;
    el.appendChild(div);
  });
}

// Toggle taken status
function toggleTaken(i) {
  const today = new Date().toISOString().slice(0, 10);
  const todayMeds = meds.filter(m => {
    const medDate = new Date(m.when || m.timestamp || Date.now()).toISOString().slice(0, 10);
    return medDate === today || (m.repeat || 'daily') === 'daily';
  });
  
  if (todayMeds[i]) {
    todayMeds[i].takenToday = !todayMeds[i].takenToday;
    localStorage.setItem('mitraMeds', JSON.stringify(meds));
    renderToday();
  }
}

// Delete medication
function deleteMed(idx) {
  meds.splice(idx, 1);
  localStorage.setItem('mitraMeds', JSON.stringify(meds));
  renderMeds();
  renderToday();
}

// Handle AI Commands
async function handleAICommand(text) {
  if (!text.trim()) return;
  
  const responseEl = $('#aiResponse');
  responseEl.textContent = 'ü§î Processing with AI...';
  $('#statusText').textContent = 'Thinking...';
  
  try {
    const reply = await window.askAI(text);
    responseEl.textContent = reply;
    $('#statusText').textContent = 'Ready';
    
    // If medication scheduled, add to local storage
    if (reply.includes('Medication scheduled')) {
      // Extract medication details from command
      const medMatch = text.match(/([a-z]+)\s+(morning|afternoon|evening|night)\s*(\d+mg)?/i);
      if (medMatch) {
        meds.push({
          name: medMatch[1],
          medicine: medMatch[1],
          time: medMatch[2],
          dose: medMatch[3] || '',
          when: new Date().toISOString(),
          timestamp: Date.now(),
          takenToday: false,
          repeat: 'daily'
        });
        localStorage.setItem('mitraMeds', JSON.stringify(meds));
        renderMeds();
        renderToday();
      }
    }
  } catch (error) {
    responseEl.textContent = '‚ùå Error: ' + error.message;
    $('#statusText').textContent = 'Error';
  }
}

// Voice Recognition
function initVoice() {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) {
    alert('Speech recognition not supported. Use Chrome or Edge.');
    return null;
  }
  
  recognition = new SR();
  recognition.lang = 'en-IN';
  recognition.continuous = false;
  recognition.interimResults = false;
  
  recognition.onstart = () => {
    isListening = true;
    $('#statusText').textContent = 'Listening...';
  };
  
  recognition.onend = () => {
    isListening = false;
    $('#statusText').textContent = 'Idle';
  };
  
  recognition.onresult = (event) => {
    const transcript = event.results[0][0].transcript;
    $('#aiInput').value = transcript;
    handleAICommand(transcript);
  };
  
  return recognition;
}

// Event Listeners
$('#aiSend').onclick = () => handleAICommand($('#aiInput').value);
$('#aiInput').onkeypress = (e) => {
  if (e.key === 'Enter') handleAICommand($('#aiInput').value);
};
$('#startMic').onclick = () => {
  if (!recognition) recognition = initVoice();
  if (recognition && !isListening) recognition.start();
};
$('#stopMic').onclick = () => {
  if (recognition && isListening) recognition.stop();
};

// Make functions global
window.toggleTaken = toggleTaken;
window.deleteMed = deleteMed;
window.loadMeds = loadMeds;

// Initialize
loadMeds();
</script>

</body>
</html>