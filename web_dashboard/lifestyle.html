<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" /><meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Mitra AI ‚Äî Lifestyle Manager (AI-Powered)</title>
<script src="api.js"></script>
<style>
body{
  margin:0;
  background:url("https://images.unsplash.com/photo-1506126613408-eca07ce68773?auto=format&fit=crop&w=1600&q=80") no-repeat center center fixed;
  background-size:cover;
  font-family:Poppins, sans-serif;
  color:#fff
}
body::before{content:"";position:fixed;inset:0;background:rgba(0,0,0,0.55);backdrop-filter:blur(2px);z-index:-1}
.header{display:flex;align-items:center;gap:12px;padding:18px;max-width:1100px;margin:20px auto}
.h-title{flex:1;font-size:1.6rem;color:#76ffb4;font-weight:700}
.controls{display:flex;gap:8px;align-items:center}
.btn{padding:8px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:700;transition:transform 0.2s}
.btn:hover{transform:translateY(-2px)}
.btn-voice{background:#76ffb4;color:#021207}
.btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.08);color:#fff}
.card{background:rgba(120,255,180,0.08);padding:18px;border-radius:12px;border:1px solid rgba(120,255,180,0.12);backdrop-filter:blur(6px)}
.container{max-width:800px;margin:10px auto;padding:0 18px}

.ai-section{
  background:rgba(118,255,180,0.15);
  padding:20px;
  border-radius:12px;
  border:1px solid rgba(118,255,180,0.3);
  margin-bottom:20px;
}
.ai-response{
  background:rgba(0,0,0,0.5);
  padding:12px;
  border-radius:8px;
  color:#76ffb4;
  font-family:'Courier New',monospace;
  font-size:14px;
  min-height:60px;
  margin-top:10px;
}

.input-row{display:flex;gap:8px;margin-top:12px}
.input-row input{flex:1;padding:10px;border-radius:8px;border:none;background:rgba(0,0,0,0.35);color:#fff;outline:none}
.list{margin-top:12px;display:flex;flex-direction:column;gap:10px}
.item{background:rgba(0,0,0,0.35);padding:10px;border-radius:8px;border-left:4px solid #76ffb4;display:flex;justify-content:space-between;align-items:center}
.del{background:none;border:0;color:#ff6b6b;font-size:1.1rem;cursor:pointer}
.small{font-size:0.95rem;color:#e6ffe9}
.back{display:block;text-align:center;color:#76ffb4;text-decoration:none;margin:18px auto}
</style>
</head>
<body>

<div class="header">
  <div class="h-title">üå± Mitra AI ‚Äî Lifestyle Manager</div>
  <div class="controls">
    <span class="small">Status: <span id="statusText">Idle</span></span>
    <button id="startMic" class="btn btn-voice">üéôÔ∏è Voice</button>
    <button id="stopMic" class="btn btn-ghost">Stop</button>
    <a href="index.html"><button class="btn btn-ghost">‚Üê Home</button></a>
  </div>
</div>

<div class="container">
  <div class="card">
    <h3 style="margin:0 0 15px 0;color:#76ffb4">ü§ñ AI Habit & Goal Commands</h3>
    
    <div class="ai-section">
      <div class="input-row">
        <input id="aiInput" placeholder='Say: "Add habit meditation", "Start daily reading", "Create goal exercise"'>
        <button id="aiSend" class="btn btn-voice">Send</button>
      </div>
      <div class="small" style="margin-top:8px">
        Lifestyle Commands: "Add habit [activity]", "Start [routine]", "Create goal [target]", "Track [behavior]"
      </div>
      <div id="aiResponse" class="ai-response">
        Try: "Add habit morning meditation", "Start daily journaling", "Create goal drink more water"
      </div>
    </div>

    <h3 style="margin:20px 0 10px 0;color:#76ffb4">Your Habits & Goals</h3>
    <div class="list" id="lifeList">
      <div class="small">Loading...</div>
    </div>
  </div>
</div>

<a class="back" href="index.html">‚Üê Back to Dashboard</a>

<script>
const $ = s => document.querySelector(s);
let habits = [];
let recognition = null;
let isListening = false;

// Load habits
async function loadHabits() {
  try {
    const stored = localStorage.getItem('mitraLifestyle');
    habits = stored ? JSON.parse(stored) : [];
    renderHabits();
  } catch (error) {
    console.error('Error loading habits:', error);
  }
}

// Render habits
function renderHabits() {
  const el = $('#lifeList');
  
  if (!habits || habits.length === 0) {
    el.innerHTML = '<div class="small">No habits yet. Use AI to add your first habit or goal!</div>';
    return;
  }
  
  el.innerHTML = '';
  
  habits.slice().reverse().forEach((habit, i) => {
    const idx = habits.length - 1 - i;
    const date = new Date(habit.when || habit.timestamp || Date.now());
    const div = document.createElement('div');
    div.className = 'item';
    div.innerHTML = `
      <div>
        <strong>üå± ${habit.text || habit.habit}</strong>
        <div class="small">${date.toLocaleDateString()}</div>
      </div>
      <button class="del" onclick="deleteHabit(${idx})">üóë</button>
    `;
    el.appendChild(div);
  });
}

// Extract habit from text with comprehensive lifestyle terminology
function extractHabitFromText(text) {
  let habitText = text.toLowerCase()
    .replace(/add|habit|goal|start|create|begin|track|monitor|establish/gi, '')
    .replace(/i want to|i need to|i should|let me|help me/gi, '')
    .replace(/daily|every day|everyday|regularly|consistently/gi, '')
    .trim();
  
  // Lifestyle-specific corrections
  const lifestyleCorrections = {
    'meditate': 'meditation',
    'exercise': 'daily exercise',
    'workout': 'daily workout',
    'read': 'reading',
    'journal': 'journaling',
    'water': 'drink more water',
    'sleep': 'better sleep schedule',
    'wake up early': 'early morning routine',
    'eat healthy': 'healthy eating',
    'walk': 'daily walking',
    'stretch': 'daily stretching',
    'yoga': 'yoga practice',
    'pray': 'daily prayer',
    'study': 'daily study time'
  };
  
  // Apply lifestyle corrections
  Object.keys(lifestyleCorrections).forEach(key => {
    if (habitText.includes(key)) {
      habitText = lifestyleCorrections[key];
    }
  });
  
  // Clean up common phrases
  habitText = habitText.replace(/^(a |an |the )/i, '');
  
  // Capitalize first letter
  if (habitText) {
    habitText = habitText.charAt(0).toUpperCase() + habitText.slice(1);
  }
  
  return habitText || null;
}

// Delete habit
function deleteHabit(idx) {
  habits.splice(idx, 1);
  localStorage.setItem('mitraLifestyle', JSON.stringify(habits));
  renderHabits();
}

// Handle AI Commands
async function handleAICommand(text) {
  if (!text.trim()) return;
  
  const responseEl = $('#aiResponse');
  responseEl.textContent = 'ü§î Processing with AI...';
  $('#statusText').textContent = 'Thinking...';
  
  try {
    const reply = await window.askAI(text);
    responseEl.textContent = reply;
    $('#statusText').textContent = 'Ready';
    
    // If habit/goal mentioned, add to local storage
    if ((reply && (reply.includes('added') || reply.includes('Habit') || reply.includes('Goal'))) || 
        text.toLowerCase().includes('add') || text.toLowerCase().includes('habit') || 
        text.toLowerCase().includes('goal') || text.toLowerCase().includes('start')) {
      
      const habitText = extractHabitFromText(text);
      if (habitText) {
        habits.push({
          text: habitText,
          habit: habitText,
          when: new Date().toISOString(),
          timestamp: Date.now()
        });
        localStorage.setItem('mitraLifestyle', JSON.stringify(habits));
        renderHabits();
      }
    }
  } catch (error) {
    responseEl.textContent = '‚ùå Error: ' + error.message;
    $('#statusText').textContent = 'Error';
  }
}

// Voice Recognition
function initVoice() {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) {
    alert('Speech recognition not supported. Use Chrome or Edge.');
    return null;
  }
  
  recognition = new SR();
  recognition.lang = 'en-IN';
  recognition.continuous = false;
  recognition.interimResults = false;
  
  recognition.onstart = () => {
    isListening = true;
    $('#statusText').textContent = 'Listening...';
  };
  
  recognition.onend = () => {
    isListening = false;
    $('#statusText').textContent = 'Idle';
  };
  
  recognition.onresult = (event) => {
    const transcript = event.results[0][0].transcript;
    $('#aiInput').value = transcript;
    handleAICommand(transcript);
  };
  
  return recognition;
}

// Event Listeners
$('#aiSend').onclick = () => handleAICommand($('#aiInput').value);
$('#aiInput').onkeypress = (e) => {
  if (e.key === 'Enter') handleAICommand($('#aiInput').value);
};
$('#startMic').onclick = () => {
  if (!recognition) recognition = initVoice();
  if (recognition && !isListening) recognition.start();
};
$('#stopMic').onclick = () => {
  if (recognition && isListening) recognition.stop();
};

// Make functions global
window.deleteHabit = deleteHabit;
window.extractHabitFromText = extractHabitFromText;

// Initialize
loadHabits();
</script>

</body>
</html>